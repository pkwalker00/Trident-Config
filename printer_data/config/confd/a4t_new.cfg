
[extruder]
step_pin: PG9
dir_pin: PD7
enable_pin: !PG11
#gear_ratio: 5:1
gear_ratio: 25:3
#rotation_distance: 22.191
rotation_distance: 
microsteps: 22.184298318
full_steps_per_rotation: 200
nozzle_diameter: 0.400
filament_diameter: 1.75
heater_pin: PA5 
sensor_type: PT1000
sensor_pin: PC5
#pullup_resistor: 2200
min_temp: -20
max_temp: 360
min_extrude_temp: 0
pressure_advance: 0.04
pressure_advance_smooth_time: 0.040
max_extrude_cross_section: 5000.0
max_extrude_only_distance: 101
#control: pid
#pid_kp: 34.847
#pid_ki: 7.744
#pid_kd: 39.201
control: mpc
heater_power: 64
cooling_fan: fan

[tmc2209 extruder]
uart_pin: PG10
interpolate: true
#uart_address: 3
run_current: 0.5
sense_resistor: 0.110
stealthchop_threshold: 0

[fan]
pin: PA4
max_power:1.0
hardware_pwm:false
kick_start_time:0.10

[heater_fan hotend_fan] 
pin: PF8
max_power: 1.0
heater: extruder
heater_temp: 50.0
cycle_time: 0.05
tachometer_pin: PF1
tachometer_ppr: 2
tachometer_poll_interval: 0.0001

[neopixel A4T]
pin: PD15
chain_count: 3
color_order: GRBW
initial_RED: 0
initial_GREEN: 0
initial_BLUE: 0
initial_WHITE: 1.0

#[filament_switch_sensor entry]
#switch_pin: PF0
#pause_on_runout: False
#runout_gcode:
#    {% if printer.idle_timeout.state == 'Printing' %}
#        RESPOND PREFIX=tgalarm MSG="Filament Runout Sensor Triggered"
#        M117 Filament Runout Sensor Triggered
#        PAUSE
#    {% endif %}

#[filament_switch_sensor exit]
#switch_pin: PC15
#pause_on_runout: False

[gcode_macro _SET_MPC_MATERIAL]
description: Set heater MPC parameters for a given material
variable_filament_table:
    ## Update this table to adjust material settings
    {
        ## ( density, heat capacity )  # suggested heat capacity range
        "PLA"       : ( 1.25, 2.20 ),  # 1.80 - 2.20
        "PETG"      : ( 1.27, 2.20 ),  # 1.70 - 2.20
        "PC+ABS"    : ( 1.15, 2.20 ),  # 1.50 - 2.20
        "ABS"       : ( 1.06, 2.40 ),  # 1.25 - 2.40
        "ASA"       : ( 1.07, 2.10 ),  # 1.30 - 2.10
        "ASA-GF"    : ( 1.07, 2.10 ),  # 1.30 - 2.10
        "PA6"       : ( 1.12, 2.50 ),  # 2.00 - 2.50
        "PA"        : ( 1.15, 2.50 ),  # 2.00 - 2.50
        "PC"        : ( 1.20, 1.90 ),  # 1.10 - 1.90
        "TPU"       : ( 1.21, 2.00 ),  # 1.50 - 2.00
        "TPU-90A"   : ( 1.15, 2.00 ),  # 1.50 - 2.00
        "TPU-95A"   : ( 1.22, 2.00 ),  # 1.50 - 2.00
        "ABS-CF"    : ( 1.11, 2.40 ),  # 1.25 - 2.40
        "ASA-CF"    : ( 1.11, 2.10 ),  # 1.30 - 2.10
        "PA6-CF"    : ( 1.19, 2.50 ),  # 2.00 - 2.50
        "PC+ABS-CF" : ( 1.22, 2.20 ),  # 1.50 - 2.20
        "PC+CF"     : ( 1.36, 1.90 ),  # 1.10 - 1.90
        "PLA-CF"    : ( 1.29, 2.20 ),  # 1.80 - 2.20
        "PETG-CF"   : ( 1.30, 2.20 ),  # 1.70 - 2.20
    }
gcode:
    {% set material = params.MATERIAL | upper %}
    {% set heater = params.HEATER | default('extruder') %}
    {% set extruder_config = printer.configfile.settings[heater] %}

    {% if material in filament_table %}
        {% set (density, heat_capacity) = filament_table[material] %}

        RESPOND PREFIX=ðŸ”¥ MSG="Configured {heater} MPC for {material}. Density: {density}, Heat Capacity: {heat_capacity}"
    {% else %}
        {% set density = extruder_config.filament_density %}
        {% set heat_capacity=extruder_config.filament_heat_capacity %}

        RESPOND PREFIX=ðŸ”¥ MSG="Unknown material '{material}', using default mpc parameters for {heater}"
    {% endif %}

    MPC_SET HEATER={heater} FILAMENT_DENSITY={density} FILAMENT_HEAT_CAPACITY={heat_capacity}

[gcode_macro M109] # Wait Hotend Temp
rename_existing: M109.1
gcode:
    #Parameters
    {% set s = params.S|float %}

    M104 {% for p in params %}{'%s%s' % (p, params[p])}{% endfor %}  # Set hotend temp
    {% if s != 0 %}
        TEMPERATURE_WAIT SENSOR=extruder MINIMUM={s-2} MAXIMUM={s+5}   # Wait for hotend temp (within n degrees)
    {% endif %}
